import lily_light_1 from '../assets/pixels/lily_light_1.png';
import lily_light_2 from '../assets/pixels/lily_light_2.png';
import lily_light_3 from '../assets/pixels/lily_light_3.png';
import lily_light_4 from '../assets/pixels/lily_light_4.png';
import lily_dark_1 from '../assets/pixels/lily_dark_1.png';
import lily_dark_2 from '../assets/pixels/lily_dark_2.png';
import lily_dark_3 from '../assets/pixels/lily_dark_3.png';
import lily_dark_4 from '../assets/pixels/lily_dark_4.png';
import blossom_light_1 from '../assets/pixels/blossom_light_1.png';
import blossom_light_2 from '../assets/pixels/blossom_light_2.png';
import blossom_light_3 from '../assets/pixels/blossom_light_3.png';
import blossom_light_4 from '../assets/pixels/blossom_light_4.png';
import blossom_dark_1 from '../assets/pixels/blossom_dark_1.png';
import blossom_dark_2 from '../assets/pixels/blossom_dark_2.png';
import blossom_dark_3 from '../assets/pixels/blossom_dark_3.png';
import blossom_dark_4 from '../assets/pixels/blossom_dark_4.png';
import blossom_cluster_light_1 from '../assets/pixels/blossom_cluster_light_1.png';
import blossom_cluster_light_2 from '../assets/pixels/blossom_cluster_light_2.png';
import blossom_cluster_light_3 from '../assets/pixels/blossom_cluster_light_3.png';
import blossom_cluster_dark_1 from '../assets/pixels/blossom_cluster_dark_1.png';
import blossom_cluster_dark_2 from '../assets/pixels/blossom_cluster_dark_2.png';
import pad_small_light_1 from '../assets/pixels/pad_small_light_1.png';
import pad_small_light_2 from '../assets/pixels/pad_small_light_2.png';
import pad_small_light_3 from '../assets/pixels/pad_small_light_3.png';
import pad_small_dark_1 from '../assets/pixels/pad_small_dark_1.png';
import pad_small_dark_2 from '../assets/pixels/pad_small_dark_2.png';
import pad_small_dark_3 from '../assets/pixels/pad_small_dark_3.png';
import pad_ring_light from '../assets/pixels/pad_ring_light.png';
import pad_ring_dark from '../assets/pixels/pad_ring_dark.png';
import blossom_small_light_1 from '../assets/pixels/blossom_small_light_1.png';
import blossom_small_light_2 from '../assets/pixels/blossom_small_light_2.png';
import blossom_small_light_3 from '../assets/pixels/blossom_small_light_3.png';
import blossom_small_dark_1 from '../assets/pixels/blossom_small_dark_1.png';
import blossom_small_dark_2 from '../assets/pixels/blossom_small_dark_2.png';
import blossom_small_dark_3 from '../assets/pixels/blossom_small_dark_3.png';
import blossom_glow_light from '../assets/pixels/blossom_glow_light.png';
import blossom_glow_dark from '../assets/pixels/blossom_glow_dark.png';
import ripple_light from '../assets/pixels/ripple_light.png';
import ripple_dark from '../assets/pixels/ripple_dark.png';
import caustic_ripple_fine_light from '../assets/pixels/caustic_ripple_fine_light.png';
import caustic_ripple_fine_dark from '../assets/pixels/caustic_ripple_fine_dark.png';
import water_base_light from '../assets/pixels/water_base_light.png';
import water_base_dark from '../assets/pixels/water_base_dark.png';
import water_reflection_light from '../assets/pixels/water_reflection_light.png';
import water_reflection_dark from '../assets/pixels/water_reflection_dark.png';
import water_stroke_large_light from '../assets/pixels/water_stroke_large_light.png';
import water_stroke_medium_light from '../assets/pixels/water_stroke_medium_light.png';
import water_stroke_small_light from '../assets/pixels/water_stroke_small_light.png';
import water_stroke_large_dark from '../assets/pixels/water_stroke_large_dark.png';
import water_stroke_medium_dark from '../assets/pixels/water_stroke_medium_dark.png';
import water_stroke_small_dark from '../assets/pixels/water_stroke_small_dark.png';
import sun_glow_light from '../assets/pixels/sun_glow_light.png';
import sun_glow_dark from '../assets/pixels/sun_glow_dark.png';
import cloud_reflect_light from '../assets/pixels/cloud_reflect_light.png';
import cloud_reflect_dark from '../assets/pixels/cloud_reflect_dark.png';
import reeds_light from '../assets/pixels/reeds_light.png';
import reeds_dark from '../assets/pixels/reeds_dark.png';
import reeds_edge_light from '../assets/pixels/reeds_edge_light.png';
import reeds_edge_dark from '../assets/pixels/reeds_edge_dark.png';
import willow_frond_light from '../assets/pixels/willow_frond_light.png';
import willow_frond_dark from '../assets/pixels/willow_frond_dark.png';
import willow_strands_left_light from '../assets/pixels/willow_strands_left_light.png';
import willow_strands_right_light from '../assets/pixels/willow_strands_right_light.png';
import willow_strands_left_dark from '../assets/pixels/willow_strands_left_dark.png';
import willow_strands_right_dark from '../assets/pixels/willow_strands_right_dark.png';
import microgrid_light from '../assets/pixels/microgrid_light.png';
import microgrid_dark from '../assets/pixels/microgrid_dark.png';
import dither_light from '../assets/pixels/dither_light.png';
import dither_dark from '../assets/pixels/dither_dark.png';
import stroke_stipple from '../assets/pixels/stroke_stipple.png';
import stroke_crosshatch from '../assets/pixels/stroke_crosshatch.png';
import stroke_zigzag from '../assets/pixels/stroke_zigzag.png';
import frame_corners_light from '../assets/pixels/frame_corners_light.png';
import frame_corners_dark from '../assets/pixels/frame_corners_dark.png';
import speckles_dark from '../assets/pixels/speckles_dark.png';
import speckles_light from '../assets/pixels/speckles_light.png';
import vignette_radial_light from '../assets/pixels/vignette_radial_light.png';
import vignette_radial_dark from '../assets/pixels/vignette_radial_dark.png';
import vignette_haze_light from '../assets/pixels/vignette_haze_light.png';
import vignette_haze_dark from '../assets/pixels/vignette_haze_dark.png';
import bridge_arc_light from '../assets/pixels/bridge_arc_light.png';
import bridge_arc_dark from '../assets/pixels/bridge_arc_dark.png';
import bridge_arc_reflection_light from '../assets/pixels/bridge_arc_reflection_light.png';
import bridge_arc_reflection_dark from '../assets/pixels/bridge_arc_reflection_dark.png';
import koi_silhouette from '../assets/pixels/koi_silhouette.png';
import boat_silhouette from '../assets/pixels/boat_silhouette.png';

export const palette = {
  sky: { '100': '#E9F1FF', '200': '#C2D5FF', '300': '#6F8BCB', '900': '#0F1424' },
  bloom: { '100': '#F6D6ED', '200': '#E6A9D3', '300': '#BF6BAB' },
  pond: { '100': '#B8F0DF', '200': '#7ED7C4', '300': '#3F9B8A' },
  ember: { '100': '#FFE1B3', '200': '#FFC075', '300': '#F28C3C' },
  lilac: { '100': '#E5E0FF', '200': '#B1A7FF' },
  neutral: { '50': '#FFFFFF', '100': '#F7F3EA', '200': '#E1D6C8', '400': '#7A7286', '700': '#2B2A35', '900': '#171421' }
} as const;

const sceneHorizonByMoment: Record<Moment, number> = {
  morning: 0.68,
  noon: 0.7,
  twilight: 0.75,
  night: 0.66
};

const scenePalettes: Record<Mode, ScenePalette> = {
  light: {
    waterDeep: '#4A69B5',
    waterMid: '#6E8FD1',
    waterLight: '#A5BEEB',
    warmGlow: '#FFBE8C',
    bloomHighlight: '#F9C7E1',
    willowLight: '#4A8C6E',
    willowShadow: '#2E6F57'
  },
  dark: {
    waterDeep: '#10224B',
    waterMid: '#2E4F9A',
    waterLight: '#5E78C7',
    warmGlow: '#FFA66E',
    bloomHighlight: '#E7A2D4',
    willowLight: '#3F7D62',
    willowShadow: '#20533E'
  }
};

export type Mode = 'light' | 'dark';
export type Moment = 'morning' | 'noon' | 'twilight' | 'night';
export type ArtIntensity = 'rich' | 'minimal' | 'flat';

export type FeatureScene = 'bridge' | 'koi' | 'boat' | 'none';
export type FeatureSceneSetting = FeatureScene | 'auto';
export type SceneDensity = 'sparse' | 'balanced' | 'lush';
export type HorizonSetting = 'auto' | 'low' | 'mid' | 'high';

type ScenePalette = {
  waterDeep: string;
  waterMid: string;
  waterLight: string;
  warmGlow: string;
  bloomHighlight: string;
  willowLight: string;
  willowShadow: string;
};

export type Layer = {
  image: string;
  size: string;
  repeat: string;
  position: string;
  blend?: string;
};

export type RippleLayer = {
  image: string;
  size: string;
  repeat: string;
  opacity: number;
  position?: string;
};

type SpriteSet = {
  light: string[];
  dark: string[];
};

type SpriteSingle = {
  light: string;
  dark: string;
};

type DirectionalSprite = {
  light: { left: string; right: string };
  dark: { left: string; right: string };
};

type WaterStrokeSprite = {
  light: { large: string; medium: string; small: string };
  dark: { large: string; medium: string; small: string };
};

type PixelRegistry = {
  lilies: SpriteSet;
  blossoms: SpriteSet;
  blossomClusters: SpriteSet;
  padSmall: SpriteSet;
  padRing: SpriteSingle;
  blossomSmall: SpriteSet;
  blossomGlow: SpriteSingle;
  ripple: SpriteSingle;
  causticRipple: SpriteSingle;
  waterBase: SpriteSingle;
  waterReflection: SpriteSingle;
  cloudReflection: SpriteSingle;
  waterStrokes: WaterStrokeSprite;
  sunGlow: SpriteSingle;
  reeds: SpriteSingle;
  reedsEdge: SpriteSingle;
  willow: SpriteSingle;
  willowStrands: DirectionalSprite;
  microgrid: SpriteSingle;
  dither: SpriteSingle;
  stroke: { stipple: string; crosshatch: string; zigzag: string };
  frame: SpriteSingle;
  speckles: { dark: string; light: string };
  vignette: SpriteSingle;
  vignetteHaze: SpriteSingle;
  bridgeArc: SpriteSingle;
  bridgeArcReflection: SpriteSingle;
  koi: string;
  boat: string;
};

export const pixelSprites: PixelRegistry = {
  lilies: {
    light: [lily_light_1, lily_light_2, lily_light_3, lily_light_4],
    dark: [lily_dark_1, lily_dark_2, lily_dark_3, lily_dark_4]
  },
  blossoms: {
    light: [blossom_light_1, blossom_light_2, blossom_light_3, blossom_light_4],
    dark: [blossom_dark_1, blossom_dark_2, blossom_dark_3, blossom_dark_4]
  },
  blossomClusters: {
    light: [blossom_cluster_light_1, blossom_cluster_light_2, blossom_cluster_light_3],
    dark: [blossom_cluster_dark_1, blossom_cluster_dark_2]
  },
  padSmall: {
    light: [pad_small_light_1, pad_small_light_2, pad_small_light_3],
    dark: [pad_small_dark_1, pad_small_dark_2, pad_small_dark_3]
  },
  padRing: {
    light: pad_ring_light,
    dark: pad_ring_dark
  },
  blossomSmall: {
    light: [blossom_small_light_1, blossom_small_light_2, blossom_small_light_3],
    dark: [blossom_small_dark_1, blossom_small_dark_2, blossom_small_dark_3]
  },
  blossomGlow: {
    light: blossom_glow_light,
    dark: blossom_glow_dark
  },
  ripple: {
    light: ripple_light,
    dark: ripple_dark
  },
  causticRipple: {
    light: caustic_ripple_fine_light,
    dark: caustic_ripple_fine_dark
  },
  microgrid: {
    light: microgrid_light,
    dark: microgrid_dark
  },
  dither: {
    light: dither_light,
    dark: dither_dark
  },
  stroke: {
    stipple: stroke_stipple,
    crosshatch: stroke_crosshatch,
    zigzag: stroke_zigzag
  },
  frame: {
    light: frame_corners_light,
    dark: frame_corners_dark
  },
  speckles: {
    dark: speckles_dark,
    light: speckles_light
  },
  waterBase: {
    light: water_base_light,
    dark: water_base_dark
  },
  waterReflection: {
    light: water_reflection_light,
    dark: water_reflection_dark
  },
  waterStrokes: {
    light: {
      large: water_stroke_large_light,
      medium: water_stroke_medium_light,
      small: water_stroke_small_light
    },
    dark: {
      large: water_stroke_large_dark,
      medium: water_stroke_medium_dark,
      small: water_stroke_small_dark
    }
  },
  sunGlow: {
    light: sun_glow_light,
    dark: sun_glow_dark
  },
  cloudReflection: {
    light: cloud_reflect_light,
    dark: cloud_reflect_dark
  },
  reeds: {
    light: reeds_light,
    dark: reeds_dark
  },
  reedsEdge: {
    light: reeds_edge_light,
    dark: reeds_edge_dark
  },
  willow: {
    light: willow_frond_light,
    dark: willow_frond_dark
  },
  willowStrands: {
    light: { left: willow_strands_left_light, right: willow_strands_right_light },
    dark: { left: willow_strands_left_dark, right: willow_strands_right_dark }
  },
  vignette: {
    light: vignette_radial_light,
    dark: vignette_radial_dark
  },
  vignetteHaze: {
    light: vignette_haze_light,
    dark: vignette_haze_dark
  },
  bridgeArc: {
    light: bridge_arc_light,
    dark: bridge_arc_dark
  },
  bridgeArcReflection: {
    light: bridge_arc_reflection_light,
    dark: bridge_arc_reflection_dark
  },
  koi: koi_silhouette,
  boat: boat_silhouette
};

export const composeLayers = (layers: Layer[]) => {
  if (!layers.length) {
    return {
      image: 'none',
      size: 'auto',
      repeat: 'repeat',
      position: '0 0',
      blend: undefined as string | undefined
    };
  }
  // CSS paints the first background on top. We build bottom-to-top arrays,
  // so reverse here so the last-added (features/overlays) sit on top.
  const ordered = [...layers].reverse();
  const formatImage = (img: string) => {
    const t = img.trim();
    if (t.startsWith('url(') || t.startsWith('linear-gradient(') || t.startsWith('radial-gradient(')) {
      return t;
    }
    return `url(${t})`;
  };
  return {
    image: ordered.map((layer) => formatImage(layer.image)).join(', '),
    size: ordered.map((layer) => layer.size).join(', '),
    repeat: ordered.map((layer) => layer.repeat).join(', '),
    position: ordered.map((layer) => layer.position).join(', '),
    blend: ordered.some((layer) => layer.blend)
      ? ordered.map((layer) => layer.blend ?? 'normal').join(', ')
      : undefined
  };
};

export const resolveFeatureScene = (moment: Moment, preference: FeatureSceneSetting = 'auto'): FeatureScene => {
  if (preference !== 'auto') {
    return preference;
  }
  switch (moment) {
    case 'twilight':
      return 'bridge';
    case 'morning':
    case 'noon':
      return 'koi';
    case 'night':
      return 'boat';
    default:
      return 'none';
  }
};
export const getRippleLayer = (mode: Mode, moment: Moment, intensity: ArtIntensity): RippleLayer => {
  const base = mode === 'light' ? 0.30 : 0.28;
  let opacity = base;
  switch (moment) {
    case 'noon':
      opacity -= 0.06;
      break;
    case 'night':
      opacity -= 0.06;
      break;
    case 'twilight':
      if (mode === 'dark') opacity += 0.06;
      break;
  }
  if (intensity === 'minimal') opacity *= 0.7;
  if (intensity === 'flat') opacity = 0.05;
  opacity = Math.max(0.05, Math.min(opacity, 0.4));
  return {
    image: pixelSprites.ripple[mode],
    size: '200px 200px',
    repeat: 'repeat',
    position: '0 0',
    opacity
  };
};

export const getCardLayers = (mode: Mode, intensity: ArtIntensity): Layer[] => {
  const layers: Layer[] = [
    {
      image: pixelSprites.microgrid[mode],
      size: '8px 8px',
      repeat: 'repeat',
      position: '0 0',
      blend: 'soft-light'
    }
  ];
  if (intensity !== 'flat') {
    layers.push({
      image: pixelSprites.dither[mode],
      size: '8px 8px',
      repeat: 'repeat',
      position: '0 0',
      blend: 'soft-light'
    });
  }
  return layers;
};

export const getBlossomSprite = (mode: Mode) => {
  const options = pixelSprites.blossoms[mode];
  const idx = mode === 'dark' ? 2 : 1;
  return options[idx % options.length];
};

export const getStrokePattern = (series: 'HRV' | 'RHR' | 'Load' | 'Sleep'): string => {
  switch (series) {
    case 'HRV':
      return pixelSprites.stroke.stipple;
    case 'RHR':
      return pixelSprites.stroke.crosshatch;
    case 'Load':
      return pixelSprites.stroke.zigzag;
    case 'Sleep':
    default:
      return pixelSprites.stroke.stipple;
  }
};

const base = {
  palette,
  pixels: pixelSprites,
  fonts: {
    heading: '"VT323", "Courier New", monospace',
    body: '"Space Grotesk", "Inter", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif'
  },
  radii: {
    card: '22px',
    shell: '26px'
  },
  shadows: {
    soft: '0 18px 34px rgba(28, 41, 64, 0.18)',
    pixel: '0 0 0 2px rgba(23, 20, 33, 0.08), 6px 6px 0 rgba(23, 20, 33, 0.2)'
  }
};

export const lightTheme = {
  mode: 'light' as Mode,
  ...base,
  colors: {
    backgroundPage: '#F5EFE2',
    backgroundCard: 'rgba(255,255,255,0.92)',
    textPrimary: '#1E1F2E',
    textSecondary: 'rgba(30, 31, 46, 0.72)',
    borderSubtle: 'rgba(30, 31, 46, 0.14)',
    grid: 'rgba(30, 31, 46, 0.08)'
  },
  chart: {
    HRV: { stroke: palette.pond['200'], fill: 'rgba(126,215,196,0.3)' },
    RHR: { stroke: palette.ember['200'], fill: 'rgba(255,192,117,0.25)' },
    Sleep: { stroke: palette.bloom['200'], fill: 'rgba(230,169,211,0.28)' },
    Load: { stroke: palette.sky['300'], fill: 'rgba(111,139,203,0.28)' },
    grid: { stroke: 'rgba(30,31,46,0.12)' },
    tooltip: { background: 'rgba(255,255,255,0.95)', color: '#1E1F2E' }
  },
  scene: {
    palette: scenePalettes.light,
    horizonByMoment: sceneHorizonByMoment
  }
};

export const darkTheme = {
  mode: 'dark' as Mode,
  ...base,
  colors: {
    backgroundPage: palette.sky['900'],
    backgroundCard: 'rgba(20, 28, 46, 0.94)',
    textPrimary: '#F6F0E8',
    textSecondary: 'rgba(246, 240, 232, 0.72)',
    borderSubtle: 'rgba(246, 240, 232, 0.18)',
    grid: 'rgba(246, 240, 232, 0.12)'
  },
  chart: {
    HRV: { stroke: palette.pond['100'], fill: 'rgba(184,240,223,0.25)' },
    RHR: { stroke: palette.ember['100'], fill: 'rgba(255,225,179,0.22)' },
    Sleep: { stroke: palette.bloom['100'], fill: 'rgba(246,214,237,0.22)' },
    Load: { stroke: palette.sky['200'], fill: 'rgba(194,213,255,0.22)' },
    grid: { stroke: 'rgba(246,240,232,0.12)' },
    tooltip: { background: 'rgba(20,28,46,0.95)', color: '#F6F0E8' }
  },
  scene: {
    palette: scenePalettes.dark,
    horizonByMoment: sceneHorizonByMoment
  }
};

export type MonetTheme = typeof lightTheme & {
  intensity?: ArtIntensity;
  motion?: boolean;
  moment?: Moment;
  featureScene?: FeatureSceneSetting;
  willowEnabled?: boolean;
  sceneDensity?: SceneDensity;
  sceneHorizon?: number;
  horizonMode?: HorizonSetting;
  scene?: {
    palette: ScenePalette;
    horizonByMoment: Record<Moment, number>;
  };
};
